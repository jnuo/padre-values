{
  "branchName": "ralph/supabase-migration",
  "projectContext": "ViziAI - Blood test tracking app. Currently uses Google Sheets as backend. Migrating to Supabase for real database, auth, and multi-user support.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Supabase project config",
      "acceptanceCriteria": [
        "Create src/supabase_config.py that loads from environment variables",
        "Add supabase-py to requirements.txt",
        "Verify .env.example has SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, SUPABASE_SECRET_KEY",
        "Update .gitignore to exclude .env",
        "Add instructions in README for setting up Supabase credentials"
      ],
      "priority": 1,
      "passes": false,
      "notes": "User will manually create Supabase project and fill in credentials"
    },
    {
      "id": "US-002",
      "title": "Design and create Supabase database schema",
      "acceptanceCriteria": [
        "Analyze src/sheets_updater.py to understand current data structure (wide format, reference sheet)",
        "Analyze src/pdf_reader.py to see what fields are extracted from PDFs",
        "Run `supabase migration new initial_schema` to create migration file",
        "Required tables: profiles (patients), user_access (who can see whose data), reports (per PDF/date), metrics (test values with refs)",
        "Include all fields from extraction: value, unit, ref_low, ref_high",
        "Add foreign key constraints and RLS policies",
        "Add indexes on user_id, sample_date, and metric name",
        "Run `supabase db push` to apply migration to remote database",
        "Document schema with ER diagram or description in schema.md"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Analyze codebase first! Schema: profiles (patients being tracked), user_access (many-to-many: usersâ†”profiles), reports (belongs to profile), metrics (belongs to report). This allows multiple family members to access same patient data, and one user to access multiple profiles later."
    },
    {
      "id": "US-003",
      "title": "Create Supabase client wrapper",
      "acceptanceCriteria": [
        "Create src/supabase_client.py",
        "Function get_supabase_client() returns authenticated Supabase client",
        "Loads credentials from environment variables",
        "Handles missing credentials gracefully with clear error message",
        "typecheck passes (if using type hints)"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create migration script for existing Google Sheets data",
      "acceptanceCriteria": [
        "Create scripts/migrate_sheets_to_supabase.py",
        "Reads all data from current Google Sheet (SHEET_NAME)",
        "Creates a default user for existing data (owner's email or placeholder)",
        "Parses the wide format (metrics as rows, dates as columns)",
        "Inserts reports and metrics into Supabase",
        "Prints summary: X reports migrated, Y metrics total",
        "Script is idempotent (can run multiple times safely)"
      ],
      "priority": 4,
      "passes": false,
      "notes": "This migrates father's existing blood test data"
    },
    {
      "id": "US-005",
      "title": "Update Python backend to write to Supabase",
      "acceptanceCriteria": [
        "Create src/supabase_updater.py with same interface as sheets_updater",
        "Function save_report(user_id, sample_date, tests_dict) inserts to Supabase",
        "Function get_user_metrics(user_id) returns all metrics for dashboard",
        "Update main.py to use supabase_updater instead of sheets_updater",
        "Add --use-supabase flag to main.py (default: still use sheets for safety)",
        "Test with one PDF extraction and verify data in Supabase"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Keep sheets_updater working for now as fallback"
    },
    {
      "id": "US-006",
      "title": "Create Next.js API route to fetch metrics from Supabase",
      "acceptanceCriteria": [
        "Create web/src/app/api/metrics/route.ts",
        "GET endpoint returns all metrics for a user (hardcode user_id for now)",
        "Response format matches current Google Sheets API response",
        "Add NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SECRET_KEY to web/.env.example",
        "Install @supabase/supabase-js in web/"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Dashboard will call this instead of Google Sheets"
    },
    {
      "id": "US-007",
      "title": "Update dashboard to use Supabase API",
      "acceptanceCriteria": [
        "Update web/src/app/dashboard/page.tsx to fetch from /api/metrics",
        "Verify charts render correctly with Supabase data",
        "Add loading state while fetching",
        "Add error state if fetch fails",
        "Use Chrome MCP to take screenshot of localhost:3000/dashboard",
        "Verify UI matches existing dark theme and Tailwind patterns",
        "Ensure existing hardcoded login still works"
      ],
      "priority": 7,
      "passes": false,
      "notes": "This completes the Supabase migration for read path."
    },
    {
      "id": "US-007b",
      "title": "Add basic tests for Phase 1",
      "acceptanceCriteria": [
        "Set up pytest for Python: add pytest to requirements.txt",
        "Create tests/test_supabase_client.py with test for get_supabase_client()",
        "Create tests/test_migration.py with test that verifies data exists in Supabase",
        "Set up Jest for Next.js: ensure jest config exists in web/",
        "Create web/src/app/api/metrics/route.test.ts with basic API test",
        "Run `pytest` and `cd web && npm test` - all tests pass",
        "Document how to run tests in README"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Simple smoke tests - not 100% coverage, just 'does it work?' checks. STOP HERE after this - wait for user to test and approve before Phase 2."
    },
    {
      "id": "US-008",
      "title": "Set up Supabase Auth configuration",
      "acceptanceCriteria": [
        "Document how to enable Google OAuth in Supabase dashboard",
        "Create web/src/lib/supabase.ts with createClientComponentClient",
        "Create web/src/lib/supabase-server.ts for server-side auth",
        "Add auth-related env vars to web/.env.example",
        "Update README with auth setup instructions"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Supabase Auth setup - Google OAuth preferred for simplicity"
    },
    {
      "id": "US-009",
      "title": "Create login page with Google OAuth",
      "acceptanceCriteria": [
        "Create web/src/app/login/page.tsx",
        "Add 'Sign in with Google' button",
        "On success, redirect to /dashboard",
        "On error, show error message",
        "Style consistent with existing UI (Tailwind, dark theme)",
        "Test login flow end-to-end"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Protect dashboard route with auth",
      "acceptanceCriteria": [
        "Create web/src/middleware.ts for auth protection",
        "Redirect unauthenticated users from /dashboard to /login",
        "After login, redirect back to /dashboard",
        "Update /api/metrics to require authentication",
        "Return 401 if not authenticated"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Associate existing data with authenticated user",
      "acceptanceCriteria": [
        "When user first logs in, check if they have data",
        "If migrated data exists (from US-004), associate with user's Supabase user_id",
        "Update migration script to use a placeholder user_id that can be claimed",
        "Add 'claim data' flow or auto-claim on first login for owner",
        "Document the data claiming process"
      ],
      "priority": 12,
      "passes": false,
      "notes": "This connects the pre-migrated data to the real user account"
    }
  ]
}
