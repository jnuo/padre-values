# Ralph Progress Log for ViziAI
Started: 2025-01-07

## Project Goal
Migrate ViziAI from Google Sheets backend to Supabase for:
- Real database with proper schema
- User authentication (Google OAuth)
- Multi-user support
- Scalable architecture

## Codebase Patterns
(Add patterns here as you discover them)

- Python config: Use src/config.py for constants, load secrets from environment
- Google APIs: OAuth tokens stored in token_*.json files
- PDF caching: Extracted labs cached as .labs.json next to PDF
- Wide format: Current sheet has metrics as rows, dates as columns

## Supabase CLI (available and linked!)
Project is linked to ViziAI (umrhdgqvyipnraapshhl). Use these commands:
- `supabase migration new <name>` - create migration file in supabase/migrations/
- `supabase db push` - apply migrations to remote database
- `supabase db diff` - see schema differences
- `supabase gen types typescript --local > web/src/types/supabase.ts` - generate types

## Key Files
- src/config.py - All configuration constants
- src/sheets_updater.py - Current Google Sheets integration (982 lines)
- src/pdf_reader.py - OpenAI Vision extraction
- web/src/app/api/ - Next.js API routes

## Existing Data Structure

**Source 1: PDF Extraction (see src/pdf_reader.py)**
OpenAI Vision extracts this JSON from each PDF:
```json
{
  "sample_date": "2024-01-15",
  "tests": {
    "Hemoglobin": {"value": 14.2, "unit": "g/dL", "ref_low": 12.0, "ref_high": 16.0},
    "Trombosit": {"value": 250000, "unit": "10^3/µL", "ref_low": 150000, "ref_high": 400000}
  }
}
```
Cached as `.labs.json` files in downloads/ folder.

**Source 2: Google Sheet format (see src/sheets_updater.py)**
Wide format - rows=metrics, columns=dates:
```
| metric      | 2024-01-15 | 2024-02-20 | 2024-03-10 |
|-------------|------------|------------|------------|
| Hemoglobin  | 14.2       | 14.5       | 14.1       |
| Trombosit   | 250000     | 245000     | 252000     |
```

**Source 3: Reference Sheet (REFERENCE_SHEET_NAME in config)**
Stores normal ranges per metric:
```
| metric     | unit      | low    | high   |
|------------|-----------|--------|--------|
| Hemoglobin | g/dL      | 12.0   | 16.0   |
| Trombosit  | 10^3/µL   | 150000 | 400000 |
```

**Target Supabase Schema (normalized):**
```sql
-- Users from Supabase Auth
users: id (uuid), email, created_at

-- One report per PDF/sample date
reports: id, user_id (FK), file_name, sample_date, created_at

-- Individual test values with their reference ranges
metrics: id, report_id (FK), name, value, unit, ref_low, ref_high
```

**Important:** Reference ranges can vary between labs/dates, so store them per metric row, not in a separate table.

---
