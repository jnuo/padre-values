{
  "projectName": "ViziAI API Test Suite (TDD Baseline)",
  "description": "Capture ALL current API behaviors before migration. This runs FIRST to establish baseline. Migration will verify against these.",
  "branch": "ralph/supabase-migration",
  "repository": "/Users/onurovali/Documents/code/padre-values",
  "stories": [
    {
      "id": "TEST-001",
      "title": "Create test infrastructure",
      "priority": 1,
      "description": "Set up test directories and utilities for capturing and comparing API responses.",
      "implementation": [
        "Create tests/baseline/ directory",
        "Create tests/integration/ directory",
        "Create tests/utils/api_capture.py for response capture",
        "Create tests/utils/compare.py for JSON comparison"
      ],
      "testCases": [
        {
          "name": "Directories exist",
          "command": "test -d tests/baseline && test -d tests/integration && echo 'OK'",
          "expected": "OK"
        }
      ],
      "passes": true
    },
    {
      "id": "TEST-002",
      "title": "Capture /api/metrics SUCCESS responses",
      "priority": 2,
      "description": "Capture all success cases for /api/metrics endpoint.",
      "implementation": [
        "Start frontend dev server",
        "Capture default profile response",
        "Capture specific profile response",
        "Capture empty profile response (valid name, no data)",
        "Save all as baseline JSON with metadata (status code, headers)"
      ],
      "testCases": [
        {
          "name": "Capture default metrics",
          "command": "curl -s -w '\\n{\"status\": %{http_code}}' http://localhost:3000/api/metrics > tests/baseline/metrics_default.json",
          "expected": "File created, status 200, has metrics[] and values[]"
        },
        {
          "name": "Capture with profileName param",
          "command": "curl -s -w '\\n{\"status\": %{http_code}}' 'http://localhost:3000/api/metrics?profileName=YÃ¼ksel%20O.' > tests/baseline/metrics_yuksel.json",
          "expected": "File created, status 200"
        },
        {
          "name": "Capture nonexistent profile",
          "command": "curl -s -w '\\n{\"status\": %{http_code}}' 'http://localhost:3000/api/metrics?profileName=NONEXISTENT' > tests/baseline/metrics_empty.json",
          "expected": "File created, status 200, {metrics:[], values:[]}"
        },
        {
          "name": "Verify response structure",
          "command": "jq 'has(\"metrics\") and has(\"values\")' tests/baseline/metrics_default.json",
          "expected": "true"
        },
        {
          "name": "Record metric count",
          "command": "jq '.metrics | length' tests/baseline/metrics_default.json > tests/baseline/metrics_count.txt",
          "expected": "Number saved for comparison"
        },
        {
          "name": "Record value count",
          "command": "jq '.values | length' tests/baseline/metrics_default.json > tests/baseline/values_count.txt",
          "expected": "Number saved for comparison"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-003",
      "title": "Capture /api/metrics ERROR responses",
      "priority": 3,
      "description": "Capture error response format and status codes.",
      "implementation": [
        "Test with malformed request",
        "Document expected error format: {error: string}",
        "Document expected status codes"
      ],
      "testCases": [
        {
          "name": "Document error response format",
          "command": "Create tests/baseline/error_format.md documenting: {error: string} with status 500",
          "expected": "Documentation file created"
        },
        {
          "name": "Capture Content-Type header",
          "command": "curl -s -I http://localhost:3000/api/metrics | grep -i content-type > tests/baseline/metrics_headers.txt",
          "expected": "application/json"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-004",
      "title": "Capture /api/metric-order GET responses",
      "priority": 4,
      "description": "Capture GET endpoint success and edge cases.",
      "implementation": [
        "Capture default response",
        "Capture with specific profile",
        "Capture empty profile response"
      ],
      "testCases": [
        {
          "name": "Capture default order",
          "command": "curl -s -w '\\n{\"status\": %{http_code}}' http://localhost:3000/api/metric-order > tests/baseline/metric_order_default.json",
          "expected": "File created, status 200, has order[]"
        },
        {
          "name": "Capture nonexistent profile",
          "command": "curl -s -w '\\n{\"status\": %{http_code}}' 'http://localhost:3000/api/metric-order?profileName=NONEXISTENT' > tests/baseline/metric_order_empty.json",
          "expected": "File created, status 200, {order:[]}"
        },
        {
          "name": "Verify response structure",
          "command": "jq 'has(\"order\")' tests/baseline/metric_order_default.json",
          "expected": "true"
        },
        {
          "name": "Record order count",
          "command": "jq '.order | length' tests/baseline/metric_order_default.json > tests/baseline/order_count.txt",
          "expected": "Number saved"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-005",
      "title": "Capture /api/metric-order PUT responses",
      "priority": 5,
      "description": "Capture PUT endpoint success, validation errors, and edge cases.",
      "implementation": [
        "Test valid PUT request",
        "Test invalid order (not array) -> 400",
        "Test missing profile -> 404",
        "Document all response formats"
      ],
      "testCases": [
        {
          "name": "Capture invalid order error (400)",
          "command": "curl -s -X PUT http://localhost:3000/api/metric-order -H 'Content-Type: application/json' -d '{\"order\": \"not-array\"}' -w '\\n{\"status\": %{http_code}}' > tests/baseline/metric_order_put_400.json",
          "expected": "status 400, has error message"
        },
        {
          "name": "Verify 400 error format",
          "command": "jq '.error' tests/baseline/metric_order_put_400.json",
          "expected": "\"order must be an array of metric names\""
        },
        {
          "name": "Capture missing profile error (404)",
          "command": "curl -s -X PUT http://localhost:3000/api/metric-order -H 'Content-Type: application/json' -d '{\"profileName\": \"NONEXISTENT\", \"order\": []}' -w '\\n{\"status\": %{http_code}}' > tests/baseline/metric_order_put_404.json",
          "expected": "status 404, has error message"
        },
        {
          "name": "Verify 404 error format",
          "command": "jq '.error' tests/baseline/metric_order_put_404.json",
          "expected": "\"Profile not found\""
        },
        {
          "name": "Capture success response format",
          "command": "curl -s -X PUT http://localhost:3000/api/metric-order -H 'Content-Type: application/json' -d '{\"order\": []}' -w '\\n{\"status\": %{http_code}}' > tests/baseline/metric_order_put_200.json",
          "expected": "status 200, {success: true, updated: N}"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-006",
      "title": "Capture database row counts from Supabase",
      "priority": 6,
      "description": "Record exact row counts for data integrity verification.",
      "implementation": [
        "Query each table via Supabase CLI or direct connection",
        "Save counts to tests/baseline/supabase_row_counts.json"
      ],
      "testCases": [
        {
          "name": "Count profiles",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM profiles'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count reports",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM reports'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count metrics",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM metrics'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count metric_definitions",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM metric_definitions'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count metric_aliases",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM metric_aliases'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count user_access",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM user_access'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count profile_allowed_emails",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM profile_allowed_emails'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Count processed_files",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT count(*) FROM processed_files'",
          "expected": "Save to row_counts"
        },
        {
          "name": "Create summary JSON",
          "command": "Create tests/baseline/supabase_row_counts.json with all counts",
          "expected": "JSON file with {table: count} format"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-007",
      "title": "Capture sample data checksums",
      "priority": 7,
      "description": "Create checksums of actual data for verification.",
      "implementation": [
        "Export key data fields and create MD5 hashes",
        "This ensures data integrity beyond just row counts"
      ],
      "testCases": [
        {
          "name": "Checksum profiles",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT id, display_name FROM profiles ORDER BY id' | md5 > tests/baseline/checksum_profiles.txt",
          "expected": "MD5 hash saved"
        },
        {
          "name": "Checksum metrics values",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT report_id, name, value FROM metrics ORDER BY report_id, name' | md5 > tests/baseline/checksum_metrics.txt",
          "expected": "MD5 hash saved"
        },
        {
          "name": "Checksum reports",
          "command": "psql $SUPABASE_DB_URL -t -c 'SELECT id, profile_id, sample_date FROM reports ORDER BY id' | md5 > tests/baseline/checksum_reports.txt",
          "expected": "MD5 hash saved"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-008",
      "title": "Create integration test runner script",
      "priority": 8,
      "description": "Create script that runs all comparisons after migration.",
      "implementation": [
        "Create tests/run_integration_tests.sh",
        "Compares new API responses to baseline",
        "Compares database row counts",
        "Compares checksums",
        "Returns non-zero exit code on any failure"
      ],
      "testCases": [
        {
          "name": "Script created",
          "command": "test -x tests/run_integration_tests.sh && echo 'OK'",
          "expected": "OK"
        },
        {
          "name": "Script runs successfully against current (Supabase) version",
          "command": "./tests/run_integration_tests.sh",
          "expected": "All tests pass (baseline matches itself)"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-009",
      "title": "Capture login page screenshot baseline",
      "priority": 9,
      "description": "Use headless browser to capture visual baseline.",
      "implementation": [
        "Use agent-browser or puppeteer to screenshot /login",
        "Save to tests/baseline/screenshot_login.png"
      ],
      "testCases": [
        {
          "name": "Screenshot captured",
          "command": "test -f tests/baseline/screenshot_login.png && echo 'OK'",
          "expected": "OK"
        },
        {
          "name": "Screenshot is valid image",
          "command": "file tests/baseline/screenshot_login.png | grep -q PNG && echo 'OK'",
          "expected": "OK"
        }
      ],
      "passes": false
    },
    {
      "id": "TEST-010",
      "title": "Document all HTTP status codes and error messages",
      "priority": 10,
      "description": "Create reference document of all expected behaviors.",
      "implementation": [
        "Create tests/baseline/API_CONTRACT.md",
        "Document each endpoint, method, params, responses, status codes",
        "This serves as the contract that migration must preserve"
      ],
      "testCases": [
        {
          "name": "API contract document created",
          "command": "test -f tests/baseline/API_CONTRACT.md && echo 'OK'",
          "expected": "OK"
        },
        {
          "name": "Document covers /api/metrics",
          "command": "grep -q '/api/metrics' tests/baseline/API_CONTRACT.md && echo 'OK'",
          "expected": "OK"
        },
        {
          "name": "Document covers /api/metric-order",
          "command": "grep -q '/api/metric-order' tests/baseline/API_CONTRACT.md && echo 'OK'",
          "expected": "OK"
        },
        {
          "name": "Document lists all status codes",
          "command": "grep -E '(200|400|404|500)' tests/baseline/API_CONTRACT.md | wc -l",
          "expected": "At least 4 (one for each code)"
        }
      ],
      "passes": false
    }
  ]
}
